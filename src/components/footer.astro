---
import { getCollection } from "astro:content";

// Current path without trailing slash
const pathname = Astro.url.pathname.replace(/\/$/, "");
const segments = pathname === "" ? [] : pathname.split("/").filter(Boolean);

// Collections to search
const collections = ["pages", "autour-du-zen", "meditation-zen", "ateliers", "dojos", "events"];
let allEntries: { slug: string; fullSlug: string; data: any; col: string }[] = [];

for (const col of collections) {
  try {
    const entries = await getCollection(col);
    allEntries = allEntries.concat(
      entries.map((entry) => ({
        slug: entry.slug,
        fullSlug: `${col}/${entry.slug}`,
        data: entry.data,
        col,
      }))
    );
  } catch (e) {
    // ignore missing collections
  }
}

const getTitleForSlug = (slug: string) => {
  const topLevel = slug.split("/")[0];
  const protectedTopLevels = [
    "autour-du-zen",
    "meditation-zen",
    "ateliers",
    "dojos",
    "events",
    "sesshins-et-stages-zen",
    "godos",
    "sesshins",
    "matinees",
    "journees",
    "decouverte",
  ];
  if (protectedTopLevels.includes(slug)) {
    return undefined;
  }

  const matchFull = allEntries.find((entry) => entry.fullSlug === slug);
  if (matchFull) return matchFull.data.title;

  const lastSegment = slug.split("/").pop();
  const matchShort = allEntries.find((entry) => entry.slug === lastSegment);
  return matchShort?.data.title;
};

let breadcrumb: { name: string; href: string }[] = [];
let accumulatedPath = "";

segments.forEach((seg) => {
  accumulatedPath += (accumulatedPath ? "/" : "") + seg;
  let name = getTitleForSlug(accumulatedPath);

  if (!name) {
    const customSegmentNames: Record<string, string> = {
      "autour-du-zen": "Zen et dojo",
      "meditation-zen": "Zen et sangha",
      "ateliers": "Ateliers",
      "dojos": "Dojos",
      "events": "Événements",
      "sesshins-et-stages-zen": "Activités précédentes",
      "godos": "Stages de zazen par godo",
      "sesshins": "Sesshins précédentes",
      "matinees": "Matinées de zazen précédentes",
      "journees": "Journées de zazen précédentes",
      "decouverte": "Journées de découverte précédentes",
    };
    name = customSegmentNames[seg] ?? decodeURIComponent(seg.replace(/-/g, " "));
  }

  breadcrumb.push({ name, href: "/" + accumulatedPath });
});
---

<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Site Zen</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        overflow-x: hidden;
      }
      main {
        flex: 1;
      }
      footer {
        flex-shrink: 0;
      }
    </style>
  </head>
  <body>
    <main>
      <!-- Ton contenu principal s'affiche ici automatiquement via Astro -->
      <slot />
    </main>

    <footer class="my-8">
      {breadcrumb.length > 0 && (
        <nav aria-label="Fil d’Ariane" class="mb-4" itemscope itemtype="https://schema.org/BreadcrumbList">
          <ol class="flex flex-wrap justify-center items-center text-sm text-gray-600 gap-2">
            <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
              <a href="/" itemprop="item" class="hover:text-teal-600">
                <span itemprop="name">Accueil</span>
              </a>
              <meta itemprop="position" content="1" />
            </li>

            {breadcrumb.map((crumb, idx) => {
              const isLast = idx === breadcrumb.length - 1;
              return (
                <li class="flex items-center gap-2" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                  <span class="text-gray-400">›</span>
                  {isLast ? (
                    <span class="font-medium text-gray-800" itemprop="name">{crumb.name}</span>
                  ) : (
                    <a href={crumb.href} itemprop="item" class="hover:text-teal-600">
                      <span itemprop="name">{crumb.name}</span>
                    </a>
                  )}
                  <meta itemprop="position" content={String(idx + 2)} />
                </li>
              );
            })}
          </ol>
        </nav>
      )}

      <section>
        <div class="mt-6 flex justify-center gap-4">
          <!-- Facebook -->
<a
  href="https://www.facebook.com/DojoZendeParis"
  target="_blank"
  rel="noopener noreferrer me"
  aria-label="Facebook — Zen Paris"
  class="inline-flex items-center justify-center h-7 w-7 rounded-full
         text-white transition-colors"
>
  <img
    src="/assets/facebook.svg"
    alt=""
    aria-hidden="true"
    class="h-6.5 w-6.5"
  />
</a>

          <!-- YouTube -->
          <a
            href="https://www.youtube.com/channel/UC0gI9NJJsfRI3fymYgm9z3g"
            target="_blank"
            rel="noopener noreferrer me"
            aria-label="YouTube — Zen Paris"
  class="inline-flex items-center justify-center h-7 w-7 rounded-full
         text-white transition-colors"
>
  <img
    src="/assets/youtube.svg"
    alt=""
    aria-hidden="true"
    class="h-6.5 w-6.5"
  />
</a>

          <!-- Instagram -->
          <a
            href="https://www.instagram.com/kosensangha/"
            target="_blank"
            rel="noopener noreferrer me"
            aria-label="Instagram — Kosen Sangha"
  class="inline-flex items-center justify-center h-7 w-7 rounded-full
         text-white transition-colors"
>
  <img
    src="/assets/instagram.svg"
    alt=""
    aria-hidden="true"
    class="h-6.5 w-6.5"
  />
</a>

          <!-- Podcast -->
          <a
            href="https://zen-montpellier.fr/enseignements-bouddhisme-zen/dojo-zen-montpellier/"
            target="_blank"
            rel="noopener noreferrer me"
            aria-label="Podcast — Dojo Zen Montpellier"
  class="inline-flex items-center justify-center h-7 w-7 rounded-full
         text-white transition-colors"
>
  <img
    src="/assets/podcast.svg"
    alt=""
    aria-hidden="true"
    class="h-6.5 w-6.5"
  />
</a>
	</div>
	        <div class="mt-6 flex justify-center gap-4">

<p class="text-[11px] text-gray-400">
  <a href="/politique-de-confidentialite/" class="hover:text-gray-600">
    Politique de confidentialité
  </a>
  –
  <a href="/mentions-legales/" class="hover:text-gray-600">
    Mentions légales
  </a>
</p>
        </div>
      </section>
    </footer>
  </body>
</html>
