---
import { getCollection } from "astro:content";

// Current path without trailing slash
const pathname = Astro.url.pathname.replace(/\/$/, "");
const segments = pathname === "" ? [] : pathname.split("/").filter(Boolean);

// Collections to search
const collections = ["pages", "zen-et-dojo", "zen-et-sangha", "ateliers", "dojos", "events"];
let allEntries: { slug: string; fullSlug: string; data: any; col: string }[] = [];

for (const col of collections) {
  try {
    const entries = await getCollection(col);
    allEntries = allEntries.concat(
      entries.map((entry) => ({
        slug: entry.slug,
        fullSlug: `${col}/${entry.slug}`,
        data: entry.data,
        col,
      }))
    );
  } catch (e) {
    // ignore missing collections
  }
}

const getTitleForSlug = (slug: string) => {
  const topLevel = slug.split("/")[0];
  const protectedTopLevels = [
    "zen-et-dojo",
    "zen-et-sangha",
    "ateliers",
    "dojos",
    "events",
    "sesshins-et-stages-zen",
    "godos",
    "sesshins",
    "matinees",
    "journees",
    "decouverte",
  ];
  if (protectedTopLevels.includes(slug)) {
    return undefined;
  }

  const matchFull = allEntries.find((entry) => entry.fullSlug === slug);
  if (matchFull) return matchFull.data.title;

  const lastSegment = slug.split("/").pop();
  const matchShort = allEntries.find((entry) => entry.slug === lastSegment);
  return matchShort?.data.title;
};

let breadcrumb: { name: string; href: string }[] = [];
let accumulatedPath = "";

segments.forEach((seg) => {
  accumulatedPath += (accumulatedPath ? "/" : "") + seg;
  let name = getTitleForSlug(accumulatedPath);

  if (!name) {
    const customSegmentNames: Record<string, string> = {
      "zen-et-dojo": "Zen et dojo",
      "zen-et-sangha": "Zen et sangha",
      "ateliers": "Ateliers",
      "dojos": "Dojos",
      "events": "Événements",
      "sesshins-et-stages-zen": "Activités précédentes",
      "godos": "Stages de zazen par godo",
      "sesshins": "Sesshins précédentes",
      "matinees": "Matinées de zazen précédentes",
      "journees": "Journées de zazen précédentes",
      "decouverte": "Journées de découverte précédentes",
    };
    name = customSegmentNames[seg] ?? decodeURIComponent(seg.replace(/-/g, " "));
  }

  breadcrumb.push({ name, href: "/" + accumulatedPath });
});
---

<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Site Zen</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        overflow-x: hidden;
      }
      main {
        flex: 1;
      }
      footer {
        flex-shrink: 0;
      }
    </style>
  </head>
  <body>
    <main>
      <!-- Ton contenu principal s'affiche ici automatiquement via Astro -->
      <slot />
    </main>

    <footer class="my-8">
      {breadcrumb.length > 0 && (
        <nav aria-label="Fil d’Ariane" class="mb-4" itemscope itemtype="https://schema.org/BreadcrumbList">
          <ol class="flex flex-wrap justify-center items-center text-sm text-gray-600 gap-2">
            <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
              <a href="/" itemprop="item" class="hover:text-teal-600">
                <span itemprop="name">Accueil</span>
              </a>
              <meta itemprop="position" content="1" />
            </li>

            {breadcrumb.map((crumb, idx) => {
              const isLast = idx === breadcrumb.length - 1;
              return (
                <li class="flex items-center gap-2" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                  <span class="text-gray-400">›</span>
                  {isLast ? (
                    <span class="font-medium text-gray-800" itemprop="name">{crumb.name}</span>
                  ) : (
                    <a href={crumb.href} itemprop="item" class="hover:text-teal-600">
                      <span itemprop="name">{crumb.name}</span>
                    </a>
                  )}
                  <meta itemprop="position" content={String(idx + 2)} />
                </li>
              );
            })}
          </ol>
        </nav>
      )}

      <section>
        <div class="mt-6 flex justify-center gap-4">
          <!-- Facebook -->
          <a
            href="https://www.facebook.com/dojozendedijon"
            target="_blank"
            rel="noopener noreferrer me"
            aria-label="Facebook — Dojo Zen de Paris"
            class="inline-flex items-center justify-center h-7 w-7 rounded-full
                   bg-teal-600 text-white hover:bg-orange-500 transition-colors"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="20 30 450 450" class="h-3.5 w-3.5 fill-current">
              <path d="M279.14 288l14.22-92.66h-88.91v-60.13c0-25.35
              12.42-50.06 52.24-50.06h40.42V6.26S293.3
              0 268.08 0c-73.51 0-121.08 44.38-121.08
              124.72v70.62H86.41V288h60.59v224h92.66V288z"/>
            </svg>
          </a>

          <!-- YouTube -->
          <a
            href="https://www.youtube.com/channel/UC0gI9NJJsfRI3fymYgm9z3g"
            target="_blank"
            rel="noopener noreferrer me"
            aria-label="YouTube — Zen Paris"
            class="inline-flex items-center justify-center h-7 w-7 rounded-full
                   bg-teal-600 text-white hover:bg-orange-500 transition-colors"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="50 0 500 550" class="h-3.5 w-3.5 fill-current">
              <path d="M549.7 124.1c-6.3-23.7-24.9-42.3-48.6-48.6C458.1
              64 288 64 288 64S117.9 64 74.9 75.5c-23.7
              6.3-42.3 24.9-48.6 48.6C15.9 167.1 16
              256 16 256s-.1 88.9 10.3 131.9c6.3
              23.7 24.9 42.3 48.6 48.6C117.9 448
              288 448 288 448s170.1 0 213.1-11.5c23.7-6.3
              42.3-24.9 48.6-48.6C560.1 344.9 560
              256 560 256s.1-88.9-10.3-131.9zM232
              338.5V173.5L374 256l-142 82.5z"/>
            </svg>
          </a>

          <!-- Instagram -->
          <a
            href="https://www.instagram.com/kosensangha/"
            target="_blank"
            rel="noopener noreferrer me"
            aria-label="Instagram — Kosen Sangha"
            class="inline-flex items-center justify-center h-7 w-7 rounded-full
                   bg-teal-600 text-white hover:bg-orange-500 transition-colors"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="80 100 300 300" class="h-4.5 w-4.5 fill-current">
              <path d="M224,202.66A53.34,53.34,0,1,0,277.34,256,53.38,53.38,0,0,0,224,202.66Zm124.71-41a54,54,0,0,0-30.28-30.29C294.41,126.11,224,126.11,224,126.11s-70.41,0-94.43,5.26a54,54,0,0,0-30.28,30.29C94.11,190,94.11,256,94.11,256s0,65.95,5.26,94.42a54,54,0,0,0,30.28,30.28C153.59,386,224,386,224,386s70.41,0,94.43-5.26a54,54,0,0,0,30.28-30.28C353.89,321.95,353.89,256,353.89,256S353.89,190,348.71,161.66ZM224,338a82,82,0,1,1,82-82A82.09,82.09,0,0,1,224,338Zm85.4-148.3a19.2,19.2,0,1,1-19.2-19.2A19.2,19.2,0,0,1,309.4,189.7Z"/>
            </svg>
          </a>

          <!-- Podcast -->
          <a
            href="https://zen-montpellier.fr/enseignements-bouddhisme-zen/dojo-zen-montpellier/"
            target="_blank"
            rel="noopener noreferrer me"
            aria-label="Podcast — Dojo Zen Montpellier"
            class="inline-flex items-center justify-center h-7 w-7 rounded-full
                   bg-teal-600 text-white hover:bg-orange-500 transition-colors"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="h-4.5 w-4.5 fill-current">
              <path d="M224 0C100.3 0 0 100.3 0 224c0 92.22 55.77 171.4 135.4 205.7c-3.48-20.75-6.17-41.59-6.998-58.15C80.08 340.1 48 285.8 48 224c0-97.05 78.95-176 176-176s176 78.95 176 176c0 61.79-32.08 116.1-80.39 147.6c-.834 16.5-3.541 37.37-7.035 58.17C392.2 395.4 448 316.2 448 224C448 100.3 347.7 0 224 0zM224 312c-32.88 0-64 8.625-64 43.75c0 33.13 12.88 104.3 20.62 132.8C185.8 507.6 205.1 512 224 512s38.25-4.375 43.38-23.38C275.1 459.9 288 388.8 288 355.8C288 320.6 256.9 312 224 312zM224 280c30.95 0 56-25.05 56-56S254.1 168 224 168S168 193 168 224S193 280 224 280zM368 224c0-79.53-64.47-144-144-144S80 144.5 80 224c0 44.83 20.92 84.38 53.04 110.8c4.857-12.65 14.13-25.88 32.05-35.04C165.1 299.7 165.4 299.7 165.6 299.7C142.9 282.1 128 254.9 128 224c0-53.02 42.98-96 96-96s96 42.98 96 96c0 30.92-14.87 58.13-37.57 75.68c.1309 .0254 .5078 .0488 .4746 .0742c17.93 9.16 27.19 22.38 32.05 35.04C347.1 308.4 368 268.8 368 224z"/>
            </svg>
          </a>
        </div>
      </section>
    </footer>
  </body>
</html>
