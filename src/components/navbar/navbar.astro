---
import Container from "@/components/container.astro";
import Dropdown from "./dropdown.astro";
import { Astronav, MenuItems, MenuIcon } from "astro-navbar";
import { getCollection } from "astro:content";

/* ---------------- Pages menu ---------------- */
const pages = await getCollection("pages");
const pageMenuItems = pages
  .filter(p => !p.data.draft)
  .map(p => ({ title: p.data.title, path: `/${p.slug}` }));

/* ---------------- Autour du zen ---------------- */
const blogPosts = await getCollection("autour-du-zen");
const publishedPosts = blogPosts
  .filter(p => !p.data.draft && p.data.publishDate <= new Date())
  .sort((a, b) => new Date(b.data.publishDate) - new Date(a.data.publishDate))
  .map(p => ({ title: p.data.title, path: `/autour-du-zen/${p.slug}` }));

/* ---------------- Zen et sangha ---------------- */
const meditationzenPosts = await getCollection("meditation-zen");
const publishedZenetsanghaPosts = meditationzenPosts
  .filter(p => !p.data.draft && p.data.publishDate <= new Date())
  .sort((a, b) => new Date(b.data.publishDate) - new Date(a.data.publishDate))
  .map(p => ({ title: p.data.title, path: `/meditation-zen/${p.slug}` }));

/* ---------------- Soutras ---------------- */
const soutrasPosts = await getCollection("soutras");
const publishedSoutrasPosts = soutrasPosts
  .filter(p => !p.data.draft && p.data.publishDate <= new Date())
  .sort((a, b) => new Date(b.data.publishDate) - new Date(a.data.publishDate))
  .map(p => ({ title: p.data.title, path: `/soutras/${p.slug}` }));

/* ---------------- Navbar structure ---------------- */
const menuitems = [
  { title: "Méditation zen", children: publishedZenetsanghaPosts },
  { title: "Autour du zen", children: publishedPosts },
  { title: "Soutras", children: publishedSoutrasPosts }, // new menu
  {
    title: "Activités précédentes",
    children: [
      { title: "Par année", path: "/sesshins-et-stages-zen" },
      { title: "Sesshins", path: "/sesshins" },
      { title: "Journées", path: "/journees" },
    ],
  },
];

const heroVideo = "/assets/Zen-Paris-en-tete3.mp4";
---

<style>
/* ---------------- HERO ---------------- */
#hero {
  width: 100vw;
  transition: height 0.5s ease-in-out;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  position: relative;
  min-height: 860px;
  height: 70vh;
}

.hero-video {
  object-fit: cover;
  width: 100%;
  height: 100%;
  position: absolute;
  inset: 0;
  z-index: 1;
}

.hero-image {
  object-fit: cover;
  width: 100%;
  height: 100%;
  position: absolute;
  inset: 0;
  z-index: 1;
  display: none;
}

/* Mobile: hide video, show image */
@media (max-width: 768px) {
  .hero-video {
    display: none;
  }
  .hero-image {
    display: block;
  }
}

.hero-content {
  transition: opacity 0.5s ease, transform 0.5s ease;
  z-index: 10;
  position: relative;
  padding: 2rem;
  text-align: center;
}

#hero .overlay {
  background-color: rgba(0,0,0,0);
  position: absolute;
  inset: 0;
  z-index: 5;
}

/* shrink effect */
#hero.shrink {
  height: 200px !important;
}

.hero-content.shrink {
  opacity: 0.85;
  transform: translateY(10px);
}

/* ---------------- NAVBAR LIGHT THEME ---------------- */
#navbar {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background-color: #ffffff; 
  z-index: 50;
}

#navbar a, #navbar .dropdown-title, #navbar button span {
  color: #000000;
}

#navbar a:hover, #navbar .dropdown-title:hover {
  color: #14b8a6; 
}

/* Mobile dropdown */
.mobile-dropdown ul {
  transition: max-height 0.3s ease-in-out;
  overflow: hidden;
}

.mobile-dropdown button span {
  transition: transform 0.3s ease;
}
</style>

<!-- ================= HERO (FULL WIDTH) ================= -->
<header id="hero">
  <!-- Video for desktop -->
  <video
    class="hero-video"
    src={heroVideo}
    autoplay
    muted
    loop
    playsinline
    preload="auto"
  ></video>

  <!-- Image for mobile -->
  <img
    class="hero-image"
    src="/assets/zen-paris-meditation-zazen-paris-kosen-deshimaru.webp"
    alt="Zen Paris Hero"
  />

  <div class="overlay"></div>

  <div class="hero-content flex flex-col items-center sm:items-start gap-4">
    <a href="/" class="flex flex-col items-center sm:items-start gap-4">
      <img
        src="/assets/logo-kosen-shangha-typo-mono-blanc.svg"
        alt="Logo Kosen Shangha"
        class="h-16 sm:h-20 md:h-24 lg:h-28 w-auto"
      />

      <div class="flex flex-col text-center sm:text-left">
        <h1 class="text-white font-bold leading-tight text-2xl sm:text-3xl md:text-4xl lg:text-5xl">
          Zen Paris, Kosen sangha
        </h1>

        <p class="text-white mt-1 sm:mt-2 leading-tight text-sm sm:text-base md:text-lg lg:text-xl">
          Simplement s&rsquo;asseoir, dans un cadre simple
        </p>
      </div>
    </a>
  </div>
</header>

<!-- ================= NAVBAR (ALWAYS VISIBLE) ================= -->
<nav id="navbar" class="shadow-sm transition-shadow duration-300">
  <Container>
    <Astronav class="flex items-center justify-end py-4 relative">
      <!-- Desktop menu -->
      <MenuItems class="hidden lg:flex">
        <ul class="flex gap-4">
          {menuitems.map((item, index) => (
            <li class="relative">
              {item.children ? (
                <Dropdown
                  title={item.title}
                  children={item.children}
                  lastItem={index === menuitems.length - 1}
                  textClass="text-black hover:text-teal-500"
                  align="right"
                />
              ) : (
                <a href={item.path} class="px-3 py-2 text-black hover:text-teal-500">
                  {item.title}
                </a>
              )}
            </li>
          ))}
        </ul>
      </MenuItems>

      <!-- Mobile burger icon -->
      <div class="lg:hidden z-50">
        <button
          id="burger-toggle"
          class="text-black focus:outline-none"
          aria-label="Open menu"
        >
          <MenuIcon class="w-6 h-6" />
        </button>
      </div>

      <!-- Mobile dropdown menu -->
      <div
        id="mobile-menu"
        class="lg:hidden absolute top-full right-0 mt-2 w-64 bg-white shadow-xl rounded-2xl
               overflow-hidden max-h-0 transition-all duration-300 ease-in-out"
      >
        <ul class="flex flex-col divide-y divide-gray-300">
          {menuitems.map((item) => (
            <li class="relative">
              {item.children ? (
                <div class="mobile-dropdown">
                  <button class="w-full text-left px-4 py-3 hover:bg-gray-100 flex justify-between items-center text-black">
                    {item.title}
                    <span>▼</span>
                  </button>
                  <ul>
                    {item.children.map(child => (
                      <li>
                        <a
                          href={child.path}
                          class="block px-4 py-2 text-black hover:bg-gray-100 rounded w-full"
                        >
                          {child.title}
                        </a>
                      </li>
                    ))}
                  </ul>
                </div>
              ) : (
                <a
                  href={item.path}
                  class="block px-4 py-3 text-black hover:bg-gray-100 w-full"
                >
                  {item.title}
                </a>
              )}
            </li>
          ))}
        </ul>
      </div>
    </Astronav>
  </Container>
</nav>

<!-- ================= SCROLL HERO SHRINK ================= -->
<script>
const hero = document.getElementById("hero");
const content = document.querySelector(".hero-content");

const MAX_HEIGHT = hero.offsetHeight;
const MIN_HEIGHT = 200;
const TRIGGER = 300;

let targetRatio = 0;
let currentRatio = 0;

function lerp(a, b, t) {
  return a + (b - a) * t;
}

function update() {
  currentRatio = lerp(currentRatio, targetRatio, 0.15);
  const newHeight = MAX_HEIGHT - (MAX_HEIGHT - MIN_HEIGHT) * currentRatio;
  hero.style.height = newHeight + "px";
  content.style.opacity = 1 - 0.15 * currentRatio;
  content.style.transform = `translateY(${10 * currentRatio}px)`;

  if (Math.abs(currentRatio - targetRatio) > 0.001) {
    requestAnimationFrame(update);
  }
}

window.addEventListener("scroll", () => {
  targetRatio = Math.min(window.scrollY / TRIGGER, 1);
  requestAnimationFrame(update);
}, { passive: true });
</script>

<!-- ================= MOBILE DROPDOWN SCRIPT ================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const burger = document.getElementById("burger-toggle");
  const mobileMenu = document.getElementById("mobile-menu");

  // Toggle mobile menu
  burger.addEventListener("click", () => {
    const isOpen = mobileMenu.style.maxHeight && mobileMenu.style.maxHeight !== "0px";
    mobileMenu.style.maxHeight = isOpen ? "0px" : mobileMenu.scrollHeight + "px";
  });

  // Handle dropdowns inside mobile menu
  const dropdowns = mobileMenu.querySelectorAll(".mobile-dropdown");

  dropdowns.forEach(drop => {
    const button = drop.querySelector("button");
    const submenu = drop.querySelector("ul");
    const arrow = button.querySelector("span");

    // Collapse submenu initially
    submenu.style.maxHeight = "0px";
    arrow.style.transition = "transform 0.3s ease";

    button.addEventListener("click", () => {
      const isOpen = submenu.style.maxHeight && submenu.style.maxHeight !== "0px";

      if (isOpen) {
        submenu.style.maxHeight = "0px";
        arrow.style.transform = "rotate(0deg)";
      } else {
        submenu.style.maxHeight = submenu.scrollHeight + "px";
        arrow.style.transform = "rotate(180deg)";
      }
    });
  });
});
</script>
