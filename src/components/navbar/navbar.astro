---
import Container from "@/components/container.astro";
import Dropdown from "./dropdown.astro";
import { Astronav, MenuItems, MenuIcon } from "astro-navbar";
import { getCollection } from "astro:content";

/* ---------------- Pages menu ---------------- */
const pages = await getCollection("pages");
const pageMenuItems = pages
  .filter(p => !p.data.draft)
  .map(p => ({
    title: p.data.title,
    path: `/${p.slug}`,
  }));

/* ---------------- Zen et dojo ---------------- */
const blogPosts = await getCollection("zen-et-dojo");
const publishedPosts = blogPosts
  .filter(p => !p.data.draft && p.data.publishDate <= new Date())
  .sort((a, b) => new Date(b.data.publishDate) - new Date(a.data.publishDate))
  .map(p => ({
    title: p.data.title,
    path: `/zen-et-dojo/${p.slug}`,
  }));

/* ---------------- Zen et sangha ---------------- */
const zenetsanghaPosts = await getCollection("zen-et-sangha");
const publishedZenetsanghaPosts = zenetsanghaPosts
  .filter(p => !p.data.draft && p.data.publishDate <= new Date())
  .sort((a, b) => new Date(b.data.publishDate) - new Date(a.data.publishDate))
  .map(p => ({
    title: p.data.title,
    path: `/zen-et-sangha/${p.slug}`,
  }));

/* ---------------- Navbar structure ---------------- */
const menuitems = [
  { title: "Zen et dojo", children: publishedPosts },
  { title: "Zen et sangha", children: publishedZenetsanghaPosts },
  {
    title: "Activités précédentes",
    children: [
      { title: "Par année", path: "/sesshins-et-stages-zen" },
      { title: "Par godo", path: "/godos" },
      { title: "Sesshins", path: "/sesshins" },
      { title: "Matinées", path: "/matinees" },
      { title: "Journées", path: "/journees" },
      { title: "Découverte", path: "/decouverte" },
    ],
  },
];

const heroVideo = "/assets/Zen-Paris-en-tete3.mp4";
---

<Container>
  <!-- ================= HERO ================= -->
  <header
    id="hero"
    class="relative w-screen h-[55vh] sm:h-[65vh] lg:h-[70vh] min-h-[360px]
           overflow-hidden transition-[height] duration-500 ease-in-out"
  >
    <video
      class="absolute inset-0 w-full h-full object-cover"
      src={heroVideo}
      autoplay
      muted
      loop
      playsinline
      preload="auto"
    ></video>

    <div class="absolute inset-0 bg-black/10"></div>

    <a
      href="/"
      class="hero-content absolute inset-x-4 bottom-6 sm:left-8 sm:bottom-8
             flex flex-col sm:flex-row items-center sm:items-end gap-4 z-10
             text-center sm:text-left
             transition-all duration-500 ease-in-out"
    >
      <img
        src="/assets/logo-kosen-shangha-typo-mono-blanc.svg"
        alt="Logo Kosen Shangha"
        class="h-16 sm:h-20 md:h-24 lg:h-28 w-auto"
      />

      <div class="flex flex-col">
        <h1 class="text-white font-bold leading-tight text-2xl sm:text-3xl md:text-4xl lg:text-5xl">
          Zen Paris, Kosen sangha
        </h1>

        <p class="text-white mt-1 sm:mt-2 leading-tight text-sm sm:text-base md:text-lg lg:text-xl">
          Simplement s&rsquo;asseoir, dans un cadre simple
        </p>
      </div>
    </a>
  </header>
</Container>

<!-- ================= NAVBAR ================= -->
<nav
  id="navbar"
  class="sticky top-0 z-30 bg-white shadow-sm transition-shadow duration-300"
>
  <Container>
    <Astronav class="flex items-center justify-end py-4 relative">
      <!-- Desktop menu -->
      <MenuItems class="hidden lg:flex">
        <ul class="flex gap-4">
          {menuitems.map((item, index) => (
            <li class="relative">
              {item.children ? (
                <Dropdown
                  title={item.title}
                  children={item.children}
                  lastItem={index === menuitems.length - 1}
                  textClass="text-black hover:text-teal-600"
                  align="right"
                />
              ) : (
                <a href={item.path} class="px-3 py-2 text-black hover:text-teal-600">
                  {item.title}
                </a>
              )}
            </li>
          ))}
        </ul>
      </MenuItems>

      <!-- Mobile burger icon (hidden on desktop) -->
      <button
        id="burger-toggle"
        class="lg:hidden text-black focus:outline-none z-50"
        aria-label="Open menu"
      >
        <MenuIcon />
      </button>

      <!-- Mobile dropdown menu -->
      <div
        id="mobile-menu"
        class="lg:hidden absolute top-full right-0 mt-2 w-64 bg-white shadow-xl rounded-2xl
               overflow-hidden max-h-0 transition-all duration-300 ease-in-out"
      >
        <ul class="flex flex-col divide-y">
          {menuitems.map((item) => (
            <li class="relative">
              {item.children ? (
                <div class="mobile-dropdown">
                  <button class="w-full text-left px-4 py-3 hover:bg-gray-100 flex justify-between items-center">
                    {item.title}
                    <span class="rotate-0 transition-transform duration-300">▼</span>
                  </button>
                  <ul class="max-h-0 overflow-hidden transition-all duration-300 ease-in-out pl-4">
                    {item.children.map(child => (
                      <li>
                        <a
                          href={child.path}
                          class="block px-4 py-2 text-black hover:bg-gray-100 rounded w-full"
                        >
                          {child.title}
                        </a>
                      </li>
                    ))}
                  </ul>
                </div>
              ) : (
                <a
                  href={item.path}
                  class="block px-4 py-3 text-black hover:bg-gray-100 w-full"
                >
                  {item.title}
                </a>
              )}
            </li>
          ))}
        </ul>
      </div>
    </Astronav>
  </Container>
</nav>

<!-- ================= SCROLL & BURGER LOGIC ================= -->
<script>
  // ---------- Hero scroll shrink ----------
  const hero = document.getElementById("hero");
  const content = document.querySelector(".hero-content");
  const MIN_HEIGHT = 200;
  const TRIGGER = 60;
  let ticking = false;

  function onScroll() {
    if (!ticking) {
      requestAnimationFrame(() => {
        const scrolled = window.scrollY > TRIGGER;
        hero.style.height = scrolled ? `${MIN_HEIGHT}px` : "";
        content.style.opacity = scrolled ? "0.85" : "";
        content.style.transform = scrolled ? "translateY(10px)" : "";
        ticking = false;
      });
      ticking = true;
    }
  }
  window.addEventListener("scroll", onScroll, { passive: true });

  // ---------- Burger menu toggle ----------
  const burger = document.getElementById("burger-toggle");
  const mobileMenu = document.getElementById("mobile-menu");
  let menuOpen = false;

  burger.addEventListener("click", () => {
    menuOpen = !menuOpen;
    mobileMenu.style.maxHeight = menuOpen ? mobileMenu.scrollHeight + "px" : "0";
  });

  // ---------- Nested mobile dropdowns ----------
  document.querySelectorAll(".mobile-dropdown").forEach(drop => {
    const btn = drop.querySelector("button");
    const submenu = drop.querySelector("ul");
    const arrow = btn.querySelector("span");

    btn.addEventListener("click", () => {
      const isOpen = submenu.style.maxHeight && submenu.style.maxHeight !== "0px";
      submenu.style.maxHeight = isOpen ? "0" : submenu.scrollHeight + "px";
      arrow.style.transform = isOpen ? "rotate(0deg)" : "rotate(180deg)";
    });
  });
</script>
