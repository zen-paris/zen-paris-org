---
import Dropdown from "./dropdown.astro";
import { Astronav, MenuItems, MenuIcon } from "astro-navbar";
import { getCollection } from "astro:content";
import Container from "@/components/container.astro";
import Dropdown from "./dropdown.astro";
import { Astronav, MenuItems, MenuIcon } from "astro-navbar";
import { getCollection } from "astro:content";

/* ---------------- Pages menu ---------------- */
const pages = await getCollection("pages");
const pageMenuItems = pages
  .filter(p => !p.data.draft)
  .map(p => ({ title: p.data.title, path: `/${p.slug}` }));

/* ---------------- Zen et dojo ---------------- */
const blogPosts = await getCollection("zen-et-dojo");
const publishedPosts = blogPosts
  .filter(p => !p.data.draft && p.data.publishDate <= new Date())
  .sort((a, b) => new Date(b.data.publishDate) - new Date(a.data.publishDate))
  .map(p => ({ title: p.data.title, path: `/zen-et-dojo/${p.slug}` }));

/* ---------------- Zen et sangha ---------------- */
const zenetsanghaPosts = await getCollection("zen-et-sangha");
const publishedZenetsanghaPosts = zenetsanghaPosts
  .filter(p => !p.data.draft && p.data.publishDate <= new Date())
  .sort((a, b) => new Date(b.data.publishDate) - new Date(a.data.publishDate))
  .map(p => ({ title: p.data.title, path: `/zen-et-sangha/${p.slug}` }));

/* ---------------- Navbar structure ---------------- */
const menuitems = [
  { title: "Zen et dojo", children: publishedPosts },
  { title: "Zen et sangha", children: publishedZenetsanghaPosts },
  {
    title: "Activités précédentes",
    children: [
      { title: "Par année", path: "/sesshins-et-stages-zen" },
      { title: "Par godo", path: "/godos" },
      { title: "Sesshins", path: "/sesshins" },
      { title: "Matinées", path: "/matinees" },
      { title: "Journées", path: "/journees" },
      { title: "Découverte", path: "/decouverte" },
    ],
  },
];

const heroVideo = "/assets/Zen-Paris-en-tete3.mp4";
---

<style>
  /* ---------------- HERO ---------------- */
  #hero {
    width: 100vw; /* Full page width */
    transition: height 0.5s ease-in-out;
    overflow: hidden;
  }

  #hero video {
    object-fit: cover;
    width: 100%;
    height: 100%;
  }

  #hero.shrink {
    height: 200px !important;
  }

  .hero-content {
    transition: opacity 0.5s ease, transform 0.5s ease;
  }

  .hero-content.shrink {
    opacity: 0.85;
    transform: translateY(10px);
  }

  /* ---------------- MOBILE DROPDOWN ---------------- */
  .mobile-dropdown ul {
    transition: max-height 0.3s ease-in-out;
    overflow: hidden;
  }

  .mobile-dropdown button span {
    transition: transform 0.3s ease;
  }
</style>

<!-- ================= HERO (FULL WIDTH) ================= -->
<header
  id="hero"
  class="relative w-screen h-[70vh] min-h-[860px]"
>
  <video
    src={heroVideo}
    autoplay
    muted
    loop
    playsinline
    preload="auto"
    class="absolute inset-0 w-full h-full object-cover"
  ></video>

  <div class="absolute inset-0 bg-black/10"></div>

  <a
    href="/"
    class="hero-content absolute inset-x-4 bottom-6 sm:left-8 sm:bottom-8
           flex flex-col sm:flex-row items-center sm:items-end gap-4 z-10
           text-center sm:text-left"
  >
    <img
      src="/assets/logo-kosen-shangha-typo-mono-blanc.svg"
      alt="Logo Kosen Shangha"
      class="h-16 sm:h-20 md:h-24 lg:h-28 w-auto"
    />

    <div class="flex flex-col">
      <h1 class="text-white font-bold leading-tight text-2xl sm:text-3xl md:text-4xl lg:text-5xl">
        Zen Paris, Kosen sangha
      </h1>

      <p class="text-white mt-1 sm:mt-2 leading-tight text-sm sm:text-base md:text-lg lg:text-xl">
        Simplement s&rsquo;asseoir, dans un cadre simple
      </p>
    </div>
  </a>
</header>

<!-- ================= NAVBAR ================= -->
<nav
  id="navbar"
  class="sticky top-0 z-30 bg-white shadow-sm transition-shadow duration-300"
>
  <Container>
    <Astronav class="flex items-center justify-end py-4 relative">
      <!-- Desktop menu -->
      <MenuItems class="hidden lg:flex">
        <ul class="flex gap-4">
          {menuitems.map((item, index) => (
            <li class="relative">
              {item.children ? (
                <Dropdown
                  title={item.title}
                  children={item.children}
                  lastItem={index === menuitems.length - 1}
                  textClass="text-black hover:text-teal-600"
                  align="right"
                />
              ) : (
                <a href={item.path} class="px-3 py-2 text-black hover:text-teal-600">
                  {item.title}
                </a>
              )}
            </li>
          ))}
        </ul>
      </MenuItems>

      <!-- Mobile burger icon -->
      <div class="lg:hidden z-50">
        <button
          id="burger-toggle"
          class="text-black focus:outline-none"
          aria-label="Open menu"
        >
          <MenuIcon class="w-6 h-6" />
        </button>
      </div>

      <!-- Mobile dropdown menu -->
      <div
        id="mobile-menu"
        class="lg:hidden absolute top-full right-0 mt-2 w-64 bg-white shadow-xl rounded-2xl
               overflow-hidden max-h-0 transition-all duration-300 ease-in-out"
      >
        <ul class="flex flex-col divide-y">
          {menuitems.map((item) => (
            <li class="relative">
              {item.children ? (
                <div class="mobile-dropdown">
                  <button class="w-full text-left px-4 py-3 hover:bg-gray-100 flex justify-between items-center">
                    {item.title}
                    <span class="rotate-0">▼</span>
                  </button>
                  <ul class="max-h-0">
                    {item.children.map(child => (
                      <li>
                        <a
                          href={child.path}
                          class="block px-4 py-2 text-black hover:bg-gray-100 rounded w-full"
                        >
                          {child.title}
                        </a>
                      </li>
                    ))}
                  </ul>
                </div>
              ) : (
                <a
                  href={item.path}
                  class="block px-4 py-3 text-black hover:bg-gray-100 w-full"
                >
                  {item.title}
                </a>
              )}
            </li>
          ))}
        </ul>
      </div>
    </Astronav>
  </Container>
</nav>

<!-- ================= SCROLL HERO SHRINK ================= -->
<script>
  const hero = document.getElementById("hero");
  const content = document.querySelector(".hero-content");

  const MAX_HEIGHT = hero.offsetHeight;
  const MIN_HEIGHT = 200;
  const TRIGGER = 300;

  let targetRatio = 0;
  let currentRatio = 0;

  function lerp(a, b, t) {
    return a + (b - a) * t;
  }

  function update() {
    currentRatio = lerp(currentRatio, targetRatio, 0.15);
    const newHeight = MAX_HEIGHT - (MAX_HEIGHT - MIN_HEIGHT) * currentRatio;
    hero.style.height = newHeight + "px";
    content.style.opacity = 1 - 0.15 * currentRatio;
    content.style.transform = `translateY(${10 * currentRatio}px)`;

    if (Math.abs(currentRatio - targetRatio) > 0.001) {
      requestAnimationFrame(update);
    }
  }

  window.addEventListener("scroll", () => {
    targetRatio = Math.min(window.scrollY / TRIGGER, 1);
    requestAnimationFrame(update);
  }, { passive: true });
</script>
