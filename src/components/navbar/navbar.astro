---
import Container from "@/components/container.astro";
import Dropdown from "./dropdown.astro";
import { Astronav, MenuItems, MenuIcon } from "astro-navbar";
import { getCollection } from "astro:content";

/* ---------------- Pages menu ---------------- */
const pages = await getCollection("pages");
const pageMenuItems = pages
  .filter(p => !p.data.draft)
  .map(p => ({ title: p.data.title, path: `/${p.slug}` }));

/* ---------------- Autour du zen ---------------- */
const blogPosts = await getCollection("autour-du-zen");
const publishedPosts = blogPosts
  .filter(p => !p.data.draft && p.data.publishDate <= new Date())
  .sort((a, b) => new Date(b.data.publishDate) - new Date(a.data.publishDate))
  .map(p => ({ title: p.data.title, path: `/autour-du-zen/${p.slug}` }));

/* ---------------- Zen et sangha ---------------- */
const meditationzenPosts = await getCollection("meditation-zen");
const publishedZenetsanghaPosts = meditationzenPosts
  .filter(p => !p.data.draft && p.data.publishDate <= new Date())
  .sort((a, b) => new Date(b.data.publishDate) - new Date(a.data.publishDate))
  .map(p => ({ title: p.data.title, path: `/meditation-zen/${p.slug}` }));

/* ---------------- Soutras ---------------- */
const soutrasPosts = await getCollection("soutras");
const publishedSoutrasPosts = soutrasPosts
  .filter(p => !p.data.draft && p.data.publishDate <= new Date())
  .sort((a, b) => new Date(b.data.publishDate) - new Date(a.data.publishDate))
  .map(p => ({ title: p.data.title, path: `/soutras/${p.slug}` }));

/* ---------------- Navbar structure ---------------- */
const menuitems = [
  { title: "Méditation", children: publishedZenetsanghaPosts },
  { title: "À propos", children: publishedPosts },
  {
    title: "Stages",
    children: [
      { title: "Par année", path: "/sesshins-et-stages-zen" },
      { title: "Sesshins", path: "/sesshins" },
      { title: "Journées", path: "/journees" },
    ],
  },
  { title: "Soutras", children: publishedSoutrasPosts },
];
---

<style>
/* ---------------- HERO VIDEO ---------------- */
#hero {
  position: relative;
  width: 100vw;
  height: 70vh;
  min-height: 600px;
  overflow: hidden;
}

.hero-video {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: 1;
}

.hero-image {
  display: none;
}

@media (max-width: 768px) {
  .hero-video {
    display: none;
  }
  .hero-image {
    display: block;
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 1;
  }
}

#hero .overlay {
  position: absolute;
  inset: 0;
  z-index: 2;
  background: rgba(0,0,0,0.25);
}

.hero-content {
  position: relative;
  z-index: 3;
  padding: 2rem;
}

/* ---------------- NAVBAR ---------------- */
#navbar {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background: #ffffff;
  z-index: 50;
}
</style>

<!-- ================= HERO HEADER ================= -->
<header id="hero">
  <video
    class="hero-video"
    autoplay
    muted
    loop
    playsinline
  >
    <source src="/assets/Zen-Paris-en-tete3.mp4" type="video/mp4" />
  </video>

  <!-- Mobile fallback -->
  <img
    class="hero-image"
    src="/assets/zen-paris-meditation-zazen-paris-kosen-deshimaru.webp"
    alt="Zen Paris"
    loading="lazy"
  />

  <div class="overlay"></div>

  <div class="hero-content flex flex-col items-center sm:items-start gap-4">
    <a href="/" class="flex flex-col items-center sm:items-start gap-4">
      <img
        src="/assets/logo-kosen-shangha-typo-mono-blanc.svg"
        alt="Logo Kosen Shangha"
        class="h-16 sm:h-20 md:h-24 lg:h-28 w-auto"
      />
      <div class="text-center sm:text-left">
        <h1 class="text-white font-bold text-3xl md:text-5xl">
          Zen Paris, Kosen sangha
        </h1>
        <p class="text-white mt-2 text-lg md:text-xl">
          Simplement s&rsquo;asseoir, dans un cadre simple
        </p>
      </div>
    </a>
  </div>
</header>

<!-- ================= NAVBAR ================= -->
<nav id="navbar" class="shadow-sm">
  <Container>
    <header class="flex justify-between items-center p-4 lg:p-6">
      <Astronav>
        <div class="flex w-full lg:w-auto items-center justify-between">
          <a href="/" class="flex items-center gap-2">
            <img
              src="/assets/logo-kosen-shangha-typo-plein.svg"
              alt="Logo Zen Paris"
              class="h-14 w-auto"
            />
            <span class="font-bold text-xl">
              Zen Paris, Kosen sangha
            </span>
          </a>

          <div class="block lg:hidden">
            <MenuIcon class="w-6 h-6" />
          </div>
        </div>

        <MenuItems class="hidden w-full lg:flex">
          <ul class="flex flex-col lg:flex-row lg:gap-3">
            {menuitems.map((item, index) =>
              <li class="relative">
                {item.children ? (
                  <Dropdown
                    title={item.title}
                    children={item.children}
                    lastItem={index === menuitems.length - 1}
                  />
                ) : (
                  <a href={item.path} class="px-3 py-2">
                    {item.title}
                  </a>
                )}
              </li>
            )}
          </ul>
        </MenuItems>
      </Astronav>
    </header>
  </Container>
</nav>
