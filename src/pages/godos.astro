---
import Layout from "@/layouts/Layout.astro";
import Container from "@/components/container.astro";
import fs from "fs";
import yaml from "js-yaml";

// --- Load YAML and normalize ---
const rawEvents = yaml.load(fs.readFileSync("./src/content/events.yaml", "utf8"));
const rawAteliers = Array.isArray(rawEvents) ? rawEvents : [];

const rawDojos = yaml.load(fs.readFileSync("./src/content/dojos.yaml", "utf8"));
const dojos = Array.isArray(rawDojos) ? rawDojos : [];

// --- Build dojo lookup map ---
const dojoMap = Object.fromEntries(
  dojos.map((d) => [
    d.dojo,
    {
      name: `${d.dojo}`,
      url: `https://${d.website.replace(/^https?:\/\//, "")}`,
    },
  ])
);

// --- Date helpers ---
function formatDayFR(dayNum) {
  return dayNum === 1 ? "1<sup>er</sup>" : String(dayNum);
}

function formatDateFR(dateStr, withYear = true, withMonth = true) {
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;

  const frDay = formatDayFR(d.getDate());
  let out = frDay;
  if (withMonth) {
    const options = { month: "long" };
    const month = d.toLocaleDateString("fr-FR", options);
    out += ` ${month}`;
  }
  if (withYear) {
    out += ` ${d.getFullYear()}`;
  }
  return out;
}

function formatEventDate(fromStr, toStr) {
  const fromDate = new Date(fromStr);
  const toDate = toStr ? new Date(toStr) : null;

  if (!toDate || isNaN(toDate)) {
    return formatDateFR(fromStr);
  }

  const sameDay =
    fromDate.getFullYear() === toDate.getFullYear() &&
    fromDate.getMonth() === toDate.getMonth() &&
    fromDate.getDate() === toDate.getDate();

  if (sameDay) {
    return formatDateFR(fromStr);
  }

  const sameMonth =
    fromDate.getFullYear() === toDate.getFullYear() &&
    fromDate.getMonth() === toDate.getMonth();

  if (sameMonth) {
    return `${formatDayFR(fromDate.getDate())} - ${formatDateFR(toStr, true, true)}`;
  }

  const sameYear = fromDate.getFullYear() === toDate.getFullYear();

  if (sameYear) {
    return `${formatDateFR(fromStr, false)} - ${formatDateFR(toStr, true)}`;
  }

  return `${formatDateFR(fromStr, true)} - ${formatDateFR(toStr, true)}`;
}

// --- Group ateliers by godo (past events only) ---
const ateliersByGodo = {};
const now = new Date();

rawAteliers.forEach((event) => {
  if (!event.date) return;
  const startDate = new Date(event.date);
  if (isNaN(startDate)) return;
  if (startDate > now) return;

  const displayDate = formatEventDate(event.date, event.to);

  const godos = Array.isArray(event.godo) ? event.godo : event.godo ? [event.godo] : [];

  godos.forEach((g) => {
    if (!ateliersByGodo[g]) ateliersByGodo[g] = [];
    ateliersByGodo[g].push({
      ...event,
      displayDate,
      sortDate: startDate.getTime(),
    });
  });
});

// --- Sort events descending per godo ---
for (const g in ateliersByGodo) {
  ateliersByGodo[g].sort((a, b) => b.sortDate - a.sortDate);
}

// --- Sorted list of godos ---
const sortedGodos = Object.keys(ateliersByGodo).sort((a, b) => a.localeCompare(b));

// --- Default selected godo ---
const defaultGodo = "Maître Kosen";
---

<Layout title="Stages">
  <Container>
    <div class="mx-auto max-w-3xl mt-4">
      <h1 class="text-4xl lg:text-5xl font-bold lg:tracking-tight mt-1 lg:leading-tight text-sky-800">
        Stages de zazen par godo
      </h1>
      <p class="text-lg mt-4 text-gray-600">
        Stages de pratique de la méditation zen, zazen, dirigés par différents godos.
      </p>
    </div>


    <!-- Dropdown selection -->
    <div class="mb-6 mt-4">
      <label for="godo-select" class="block text-sm font-medium text-gray-700 mb-2">
        Choisissez un godo :
      </label>
      <select
        id="godo-select"
        class="block w-full max-w-xs rounded border-gray-300 shadow-sm focus:border-sky-500 focus:ring-teal-500"
      >
        {sortedGodos.map((godo) => (
          <option value={godo} selected={godo === defaultGodo}>
            {godo}
          </option>
        ))}
      </select>
    </div>

    <!-- Sections par godo -->
    {sortedGodos.map((godo) => (
      <section
        key={godo}
        class={`godo-section ${godo === defaultGodo ? "" : "hidden"} mt-6`}
        data-godo={godo}
      >
        <h3 class="text-2xl font-bold text-sky-800 mb-4">{godo}</h3>
        <ul class="mt-4 space-y-12">
          {ateliersByGodo[godo].map((event) => (
            <li key={event.date + event.title} class="border-b pb-8">
              <div class="flex flex-col md:flex-row gap-6 items-start">
                {event.coverImage && (
                  <img
                    src={`/assets/${event.coverImage}`}
                    alt={event.title}
                    class="w-full md:w-48 md:h-32 object-cover rounded-lg shadow cursor-pointer hover:opacity-90 transition"
                    loading="lazy"
                    data-lightbox={`/assets/${event.coverImage}`}
                  />
                )}

                <div class="flex-1">
                  <span
                    class="text-sky-800 uppercase tracking-wider text-sm font-medium"
                    set:html={event.displayDate}
                  />
                  <h4 class="text-xl font-bold mt-2">{event.title}</h4>

                  {event.description && (
                    <p class="mt-3 text-gray-700 prose prose-lg">
                      <em>{event.description}</em>
                    </p>
                  )}

                  <ul class="mt-3 space-y-1 text-gray-700 text-sm">
                    {event.dojo && dojoMap[event.dojo] && (
                      <li>
                        <strong>Lieu :</strong>{" "}
                        <a
                          href={dojoMap[event.dojo].url}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="text-sky-800 hover:underline"
                        >
                          {dojoMap[event.dojo].name}
                        </a>
                      </li>
                    )}
                    {!event.dojo && event.lieu && (
                      <li>
                        <strong>Lieu :</strong> {event.lieu}
                      </li>
                    )}
                    {event.godo && (
                      <li>
                        <strong>Dirigée par :</strong>{" "}
                        {Array.isArray(event.godo) ? event.godo.join(", ") : event.godo}
                      </li>
                    )}
                  </ul>
                </div>
              </div>
            </li>
          ))}
        </ul>
      </section>
    ))}

<!-- Lightbox overlay -->
<div
  id="lightbox"
  class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4"
>
  <button id="lightbox-prev" class="absolute left-4 sm:left-6 text-white text-4xl font-bold z-50">
    ‹
  </button>
  <img
    id="lightbox-img"
    src=""
    alt="Agrandissement"
    class="max-w-full max-h-[90vh] rounded-lg shadow-lg object-contain"
  />
  <button id="lightbox-next" class="absolute right-4 sm:right-6 text-white text-4xl font-bold z-50">
    ›
  </button>
  <button
    id="lightbox-close"
    class="absolute top-4 right-4 text-white text-3xl font-bold z-50"
  >
    &times;
  </button>
</div>

<script>
  // --- Dropdown toggle ---
  const godoSelect = document.getElementById("godo-select");
  const godoSections = document.querySelectorAll(".godo-section");

  godoSelect.addEventListener("change", () => {
    const selected = godoSelect.value;
    godoSections.forEach((sec) => {
      sec.classList.toggle("hidden", sec.dataset.godo !== selected);
    });
  });

  // --- Lightbox ---
  const lightbox = document.getElementById("lightbox");
  const lightboxImg = document.getElementById("lightbox-img");
  const lightboxClose = document.getElementById("lightbox-close");
  const lightboxPrev = document.getElementById("lightbox-prev");
  const lightboxNext = document.getElementById("lightbox-next");

  const images = Array.from(document.querySelectorAll("[data-lightbox]"));
  let currentIndex = -1;

  function showLightbox(index) {
    currentIndex = index;
    lightboxImg.src = images[index].dataset.lightbox;
    lightbox.classList.remove("hidden");
    lightbox.classList.add("flex");
  }

  images.forEach((img, index) => {
    img.addEventListener("click", () => showLightbox(index));
  });

  function closeLightbox() {
    lightbox.classList.add("hidden");
    lightbox.classList.remove("flex");
  }

  lightboxClose.addEventListener("click", closeLightbox);

  lightbox.addEventListener("click", (e) => {
    if (e.target === lightbox) closeLightbox();
  });

  lightboxPrev.addEventListener("click", (e) => {
    e.stopPropagation();
    currentIndex = (currentIndex - 1 + images.length) % images.length;
    showLightbox(currentIndex);
  });

  lightboxNext.addEventListener("click", (e) => {
    e.stopPropagation();
    currentIndex = (currentIndex + 1) % images.length;
    showLightbox(currentIndex);
  });

  document.addEventListener("keydown", (e) => {
    if (lightbox.classList.contains("hidden")) return;
    if (e.key === "ArrowLeft") {
      currentIndex = (currentIndex - 1 + images.length) % images.length;
      showLightbox(currentIndex);
    } else if (e.key === "ArrowRight") {
      currentIndex = (currentIndex + 1) % images.length;
      showLightbox(currentIndex);
    } else if (e.key === "Escape") {
      closeLightbox();
    }
  });

  let startX = 0;
  let endX = 0;

  lightboxImg.addEventListener("touchstart", (e) => {
    startX = e.touches[0].clientX;
  });

  lightboxImg.addEventListener("touchmove", (e) => {
    endX = e.touches[0].clientX;
  });

  lightboxImg.addEventListener("touchend", () => {
    const diff = endX - startX;
    if (Math.abs(diff) > 50) {
      if (diff > 0) {
        currentIndex = (currentIndex - 1 + images.length) % images.length;
      } else {
        currentIndex = (currentIndex + 1) % images.length;
      }
      showLightbox(currentIndex);
    }
    startX = 0;
    endX = 0;
  });
</script>
  </Container>
</Layout>
