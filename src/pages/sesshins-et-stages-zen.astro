---
import Layout from "@/layouts/Layout.astro";
import Container from "@/components/container.astro";
import fs from "fs";
import yaml from "js-yaml";

// --- Load YAML and normalize ---
const rawEvents = yaml.load(fs.readFileSync("./src/content/events.yaml", "utf8"));
const rawAteliers = Array.isArray(rawEvents) ? rawEvents : [];

const rawDojos = yaml.load(fs.readFileSync("./src/content/dojos.yaml", "utf8"));
const dojos = Array.isArray(rawDojos) ? rawDojos : [];

// --- Build dojo lookup map ---
const dojoMap = Object.fromEntries(
  dojos.map((d) => [
    d.dojo,
    {
      name: `${d.dojo}`,
      url: `https://${d.website.replace(/^https?:\/\//, "")}`,
    },
  ])
);

// --- Date helpers ---
function formatDayFR(dayNum) {
  return dayNum === 1 ? "1<sup>er</sup>" : String(dayNum);
}

function formatDateFR(dateStr, withYear = true, withMonth = true) {
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;

  const frDay = formatDayFR(d.getDate());
  let out = frDay;

  if (withMonth) {
    out += ` ${d.toLocaleDateString("fr-FR", { month: "long" })}`;
  }
  if (withYear) {
    out += ` ${d.getFullYear()}`;
  }
  return out;
}

function formatEventDate(fromStr, toStr) {
  const fromDate = new Date(fromStr);
  const toDate = toStr ? new Date(toStr) : null;

  if (!toDate || isNaN(toDate)) {
    return formatDateFR(fromStr);
  }

  const sameDay =
    fromDate.getFullYear() === toDate.getFullYear() &&
    fromDate.getMonth() === toDate.getMonth() &&
    fromDate.getDate() === toDate.getDate();

  if (sameDay) return formatDateFR(fromStr);

  const sameMonth =
    fromDate.getFullYear() === toDate.getFullYear() &&
    fromDate.getMonth() === toDate.getMonth();

  if (sameMonth) {
    return `${formatDayFR(fromDate.getDate())} – ${formatDateFR(toStr)}`;
  }

  const sameYear = fromDate.getFullYear() === toDate.getFullYear();
  if (sameYear) {
    return `${formatDateFR(fromStr, false)} – ${formatDateFR(toStr)}`;
  }

  return `${formatDateFR(fromStr)} – ${formatDateFR(toStr)}`;
}

// --- Group ateliers by year (past only) ---
const ateliersByYear = {};
const now = new Date();

rawAteliers.forEach((event) => {
  if (!event.date) return;
  const startDate = new Date(event.date);
  if (isNaN(startDate) || startDate > now) return;

  const year = startDate.getFullYear();
  ateliersByYear[year] ??= [];

  const key = event.date + event.title;
  if (!ateliersByYear[year].some(e => e.date + e.title === key)) {
    ateliersByYear[year].push({
      ...event,
      displayDate: formatEventDate(event.date, event.to),
      sortDate: startDate.getTime(),
    });
  }
});

// --- Sort years & events ---
const sortedYears = Object.keys(ateliersByYear).sort((a, b) => b - a);
sortedYears.forEach(year => {
  ateliersByYear[year].sort((a, b) => b.sortDate - a.sortDate);
});

// --- Navigation ---
const navItems = [
  { title: "À propos", link: "/autour-du-zen" },
  { title: "Méditation zen", link: "/meditation-zen" },
  { title: "Stages", link: "/sesshins-et-stages-zen" },
];
const currentIndex = navItems.findIndex(i => i.link === "/sesshins-et-stages-zen");
const prevIndex = (currentIndex - 1 + navItems.length) % navItems.length;
const nextIndex = (currentIndex + 1) % navItems.length;
---

<Layout title="Stages">
  <Container>
    <div class="mx-auto max-w-3xl mt-4">
      <h1 class="text-4xl lg:text-5xl font-bold text-teal-800">
        Stages
      </h1>
      <p class="text-lg mt-4 text-gray-600">
        Stages de pratique de la méditation zen, zazen.
      </p>
    </div>

    {sortedYears.map((annee) => (
      <section class="mt-14">
        <h2 class="text-3xl font-bold text-gray-700">
          {annee}
        </h2>

        <ul class="mt-8 space-y-12">
          {ateliersByYear[annee].map((event) => (
            <li class="border-b pb-8">
              <div class="flex flex-col md:flex-row gap-6">
                {event.coverImage && (
                  <img
                    src={`/assets/${event.coverImage}`}
                    alt={event.title}
                    class="w-full md:w-48 md:h-32 object-cover rounded-lg shadow cursor-pointer hover:opacity-90"
                    loading="lazy"
                    data-lightbox={`/assets/${event.coverImage}`}
                  />
                )}

                <div class="flex-1">
                  <span
                    class="text-teal-800 uppercase text-sm font-medium"
                    set:html={event.displayDate}
                  />
                  <h3 class="text-2xl font-bold mt-2">{event.title}</h3>

                  {event.description && (
                    <p class="mt-3 text-gray-700 prose prose-lg">
                      <em>{event.description}</em>
                    </p>
                  )}

                  <ul class="mt-3 space-y-1 text-sm text-gray-700">
                    {event.dojo && dojoMap[event.dojo] && (
                      <li>
                        <strong>Lieu :</strong>{" "}
                        <a
                          href={dojoMap[event.dojo].url}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="text-teal-800 hover:underline"
                        >
                          {dojoMap[event.dojo].name}
                        </a>
                      </li>
                    )}
                    {!event.dojo && event.lieu && (
                      <li><strong>Lieu :</strong> {event.lieu}</li>
                    )}
                    {event.godo && (
                      <li>
                        <strong>Dirigée par :</strong>{" "}
                        {Array.isArray(event.godo) ? event.godo.join(", ") : event.godo}
                      </li>
                    )}
                  </ul>
                </div>
              </div>
            </li>
          ))}
        </ul>
      </section>
    ))}

    <!-- Bottom Navigation -->
    <section class="mt-20 border-t pt-6">
      <div class="flex justify-between max-w-3xl mx-auto text-sm font-medium text-teal-700">
        <a href={navItems[prevIndex].link}>← {navItems[prevIndex].title}</a>
        <a href={navItems[nextIndex].link}>{navItems[nextIndex].title} →</a>
      </div>
    </section>
  </Container>
</Layout>
